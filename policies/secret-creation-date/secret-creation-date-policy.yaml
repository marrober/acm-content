apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: secret-creation-date
  namespace: rhacm-policies
  annotations:
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
    policy.open-cluster-management.io/standards: NIST SP 800-53
spec:
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: secret-creation-date
        spec:  
          evaluationInterval:
            compliant: 60s
            noncompliant: 60s
          remediationAction: inform # Set to inform to alert without deleting/changing
          severity: low
          object-templates-raw: |
            {{- /* Iterate through all namespaces */ -}}
            {{- range (lookup "v1" "Namespace" "" "").items }}
              {{- $nsName := .metadata.name -}}
              {{- /* Check if the namespace name does NOT contain 'openshift' */ -}}
              {{- if (contains "test" $nsName) }}
              {{- /* Look up secrets in this specific namespace */ -}}
                {{- range (lookup "v1" "Secret" $nsName "").items }}
                  {{- $secretName := .metadata.name -}}
                  {{- /* Calculate age: 336 hours = 14 days */ -}}
                  {{- if (gt (toInt (secondsSince .metadata.creationTimestamp)) 1209600) }}
                  - complianceType: musthave
                    objectDefinition:
                      apiVersion: v1
                      kind: Secret
                      metadata:
                        name: {{ $secretName }}
                        namespace: {{ $nsName }}
                        {{- /* The annotation below helps identify why it failed in the console */ -}}
                        annotations:
                          policy.open-cluster-management.io/age-status: "Secret is older than 14 days"
                  {{- end }}
                {{- end }}
              {{- end }}
            {{- end }}