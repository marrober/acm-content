apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: secret-creation-date
  namespace: rhacm-policies
  annotations:
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
    policy.open-cluster-management.io/standards: NIST SP 800-53
spec:
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: secret-creation-date
        spec:
          evaluationInterval:
            compliant: 60s
            noncompliant: 60s
          remediationAction: inform 
          severity: low
          object-templates-raw: |
            {{- range (lookup "v1" "Namespace" "" "").items }}
              {{- $nsName := .metadata.name -}}
              {{- $skipNamespace := false -}}
              {{- range (list "installer" "devspaces" "default" "hive" "-system" "hypershift" "kube-" "-cluster" "multicluster" "open-cluster" "openshift" "rhacs" "stackrox" "trusted-" "rhacm-" ) -}}
                {{- if contains . $nsName }} {{ $skipNamespace = true }} {{ end -}}
              {{- end -}}
              {{- if not $skipNamespace }}
                {{- range (lookup "v1" "Secret" $nsName "").items }}
                  {{- $secretName := .metadata.name -}}
                  {{- $now := now -}}
                  {{- $created := toDate "2006-01-02T15:04:05Z" .metadata.creationTimestamp -}}
                  {{- if (gt (sub (toInt $now.Unix) (toInt $created.Unix)) 3600 ) }}
                  - complianceType: mustnothave
                    objectDefinition:
                      apiVersion: v1
                      kind: Secret
                      metadata:
                        name: '{{ $secretName }}'
                        namespace: '{{ $nsName }}'
                  {{- end }}
                {{- end }}
              {{- end }}
            {{- end }}